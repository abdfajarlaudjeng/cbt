<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CBT Siswa SMP - Sistem Ujian Online</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" class="min-h-screen flex flex-col justify-center items-center p-6">
    <main class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl">
      <h1 class="text-2xl font-bold text-center mb-4">CBT Siswa SMP</h1>

      <!-- Form Identitas -->
      <div id="loginForm">
        <label class="block font-semibold">Nama:</label>
        <input id="studentName" type="text" class="border p-2 w-full rounded mb-3" placeholder="Nama siswa" />
        <label class="block font-semibold">NIS:</label>
        <input id="studentId" type="text" class="border p-2 w-full rounded mb-3" placeholder="Nomor Induk Siswa" />
        <label class="block font-semibold">Kelas:</label>
        <select id="studentGrade" class="border p-2 w-full rounded mb-3">
          <option value="">Pilih Kelas</option>
          <option value="7">Kelas 7</option>
          <option value="8">Kelas 8</option>
          <option value="9">Kelas 9</option>
        </select>
        <button onclick="loadQuestions()" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700">Mulai Ujian</button>
      </div>

      <!-- Soal -->
      <div id="examSection" class="hidden">
        <h2 class="text-xl font-bold mb-4">Ujian Dimulai</h2>
        <div id="questionsContainer" class="space-y-6"></div>
        <button onclick="finishExam()" class="bg-green-600 text-white px-4 py-2 rounded w-full hover:bg-green-700 mt-4">
          Selesai Ujian
        </button>
        <p id="statusMsg" class="text-center text-green-600 font-semibold mt-3"></p>
      </div>

      <!-- Hasil -->
      <div id="resultSection" class="hidden text-center">
        <h2 class="text-2xl font-bold mb-3">Hasil Ujian</h2>
        <p id="scoreText" class="text-lg font-semibold"></p>
        <p id="remarkText" class="text-xl font-bold mt-2"></p>
      </div>
    </main>
  </div>

  <script>
    // Ganti URL di bawah dengan URL web app Apps Script kamu
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwehMV6cj54I2m-Z1zeWTITYMIikKeas0MdyumlmeyJkVzDgxAicHlGZUI4RuW733M/exec";

    let student = {};
    let questions = [];

    // Ambil soal dari Google Spreadsheet berdasarkan kelas
    async function loadQuestions() {
      const name = document.getElementById("studentName").value.trim();
      const id = document.getElementById("studentId").value.trim();
      const grade = document.getElementById("studentGrade").value.trim();

      if (!name || !id || !grade) {
        alert("Lengkapi semua data siswa!");
        return;
      }

      student = { name, id, grade };

      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("examSection").classList.remove("hidden");

      try {
        const sheetName = "Kelas " + grade;
        const url = `${SCRIPT_URL}?sheet=${encodeURIComponent(sheetName)}`;
        const res = await fetch(url);
        const data = await res.json();

        questions = data.filter(row => row.Pertanyaan); // pastikan hanya baris yang valid

        const container = document.getElementById("questionsContainer");
        container.innerHTML = "";

        questions.forEach((q, index) => {
          const div = document.createElement("div");
          div.classList.add("border", "p-3", "rounded", "shadow-sm");

          let html = `<p><b>${q["No."] || index + 1}.</b> ${q.Pertanyaan}</p>`;
          
          // tampilkan gambar/video jika ada
          if (q["Link Gambar"]) {
            html += `<img src="${q["Link Gambar"]}" class="w-full max-h-64 object-contain mt-2 rounded">`;
          }
          if (q["Link Video"]) {
            html += `<div class="mt-2"><iframe width="100%" height="200" src="${q["Link Video"]}" frameborder="0" allowfullscreen></iframe></div>`;
          }

          ["A", "B", "C", "D"].forEach(opt => {
            html += `<label class='block mt-1'>
              <input type='radio' name='soal${index}' value='${opt}'> ${opt}. ${q[opt]}
            </label>`;
          });

          div.innerHTML = html;
          container.appendChild(div);
        });
      } catch (error) {
        console.error(error);
        alert("Gagal memuat soal. Periksa koneksi internet atau izin file.");
      }
    }

    async function finishExam() {
      const jawabanSiswa = [];
      let benarCount = 0;

      questions.forEach((q, i) => {
        const jawaban = document.querySelector(`input[name='soal${i}']:checked`)?.value || "";
        const kunci = q["Jawaban Benar"]?.trim().toUpperCase() || "";
        const benarSalah = jawaban === kunci ? "Benar" : "Salah";
        if (benarSalah === "Benar") benarCount++;
        jawabanSiswa.push({
          nomor: q["No."] || i + 1,
          pertanyaan: q.Pertanyaan,
          jawaban,
          kunci,
          benarSalah,
        });
      });

      const totalSoal = questions.length;
      const skor = Math.round((benarCount / totalSoal) * 100);
      const keterangan = skor >= 75 ? "LULUS ðŸŽ‰" : "BELUM LULUS ðŸ˜”";

      await submitToSheets(jawabanSiswa, skor);

      document.getElementById("examSection").classList.add("hidden");
      document.getElementById("resultSection").classList.remove("hidden");
      document.getElementById("scoreText").innerText = `Skor kamu: ${skor} (${benarCount} benar dari ${totalSoal})`;
      document.getElementById("remarkText").innerText = keterangan;
    }

    async function submitToSheets(jawabanSiswa, skor) {
      try {
        const payload = { nama: student.name, nis: student.id, kelas: student.grade, jawabanSiswa, skor };
        const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        const result = await res.json();
        document.getElementById("statusMsg").innerText = result.message || "Data tersimpan.";
      } catch (error) {
        console.error(error);
        alert("Gagal mengirim data. Periksa koneksi internet.");
      }
    }
  </script>
</body>
</html>
